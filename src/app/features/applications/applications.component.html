<div class="p-7">
  <div class="rounded-2xl shadow bg-white p-6">
    <nav class="flex gap-4 justify-between items-center flex-wrap md:flex-row flex-col">
      <div class="flex gap-2 items-center">
        <!-- Search -->
        <div class="bg-stone-100 w-full md:max-w-md flex h-11 items-center rounded-2xl ps-4 gap-4">
          <label
            for="searchApp"
            class="relative size-4 shrink-0 cursor-pointer"
            (click)="this.searchService.updateQuery(search)"
            ><img ngSrc="/assets/icons/search.svg" alt="Search" fill
          /></label>
          <input
            type="text"
            id="searchApp"
            [(ngModel)]="search"
            (keyup.enter)="this.searchService.updateQuery(search)"
            placeholder="search"
            class="bg-transparent grow h-full px-2"
          />
        </div>
        <div class="max-md:w-full shrink-0">
          <app-custom-select
            [options]="statuses.values"
            [labels]="statuses.labels"
            [(ngModel)]="status"
            placeholder="Select Status"
            (ngModelChange)="onSearch()"
          />
        </div>
        <div class="max-md:w-full shrink-0">
          <app-custom-select [options]="periods" [(ngModel)]="period" (ngModelChange)="onSearch()" />
        </div>
      </div>

      @defer (when permissions.hasPermission(permission.CREATE_APPLICATION)) {
        <div class="max-md:w-full">
          <a
            class="flex items-center gap-2 bg-secondary text-white px-4 py-2 rounded-lg"
            routerLink="/applications/create"
          >
            <div class="relative size-5 shrink-0"><img ngSrc="/assets/icons/add.svg" alt="Create" fill /></div>
            Create
          </a>
        </div>
      }
    </nav>

    <hr class="my-4" />
    <section>
      <div class="relative overflow-x-auto">
        <table class="w-full text-left">
          <thead>
            <tr class="*:font-normal *:text-neutral-400 *:px-6 *:py-3">
              <th scope="col">Company</th>
              <th scope="col">Product</th>
              <th scope="col">Quantity</th>
              <th scope="col">Period</th>
              <th scope="col">Creation</th>
              <th scope="col">Status</th>
              <th scope="col"></th>
            </tr>
          </thead>
          @if (loading()) {
            <tbody>
              <td colspan="100%">
                <div class="text-center py-9">
                  <div class="loader"></div>
                </div>
              </td>
            </tbody>
          } @else {
            @if (application() && application()!.data!.length > 0) {
              <tbody>
                @for (application of application()?.data; track application.id) {
                  <tr
                    class="bg-white border-b border-dashed border-neutral-200 *:px-4 *:py-4 *:whitespace-nowrap [&>th]:ps-0"
                  >
                    <th scope="row" class="font-normal">
                      <a [routerLink]="[application.id]">
                        <div class="flex gap-4 items-center">
                          <div
                            class="size-10 bg-primary rounded-lg text-white flex items-center justify-center uppercase"
                          >
                            {{ application.company.name | initials }}
                          </div>
                          <div>
                            <p class="font-bold">{{ application.company.name }}</p>

                            <div class="flex items-center gap-2">
                              <div class="relative size-5">
                                <img
                                  [ngSrc]="
                                    'https://raw.githubusercontent.com/hampusborgos/country-flags/main/svg/' +
                                    application.company.country_iso_code_2.toLowerCase() +
                                    '.svg'
                                  "
                                  [alt]="application.company.country_iso_code_2"
                                  fill
                                />
                              </div>
                              {{ application.company.dba }}
                            </div>
                          </div>
                        </div>
                      </a>
                    </th>
                    <td>
                      {{ config.productType()[application.product] }}
                    </td>
                    <td>{{ application.loan_amount | currency }}</td>
                    <td>
                      {{ application.period }}
                    </td>
                    <td>
                      {{ application.created_at | customDate }}
                      @if (application.created_by) {
                        <br />by {{ application.created_by.first_name }} {{ application.created_by.last_name }}
                      }
                    </td>
                    <td>
                      <!-- TODO: Asignar un color para cada status   -->
                      <p
                        class="text-center rounded-lg inline-block px-3 py-1 text-white"
                        [ngClass]="config.statusClasses()[application.status]"
                      >
                        {{ config.applicationStatus()[application.status] }}
                      </p>
                    </td>
                    <td>
                      <div class="flex items-center justify-center gap-2">
                        @defer (when permissions.hasPermission(permission.DELETE_APPLICATION)) {
                          @if (application.status === 'READY_TO_SEND') {
                            <button (click)="deleteApplicationModal.open(); wiewing.set(application.id)" type="button">
                              <img src="assets/icons/trash-icon.svg" alt="delete" class="cursor-pointer size-5" />
                            </button>
                          }
                        }
                        @if (
                          permissions.hasPermission(permission.TRANSFER_APPLICATION) &&
                          application.status != 'COMPLETED'
                        ) {
                          <button
                            class="size-5 relative"
                            type="button"
                            (click)="wiewing.set(application.id); transferAppModal.open()"
                          >
                            <img src="/assets/icons/transfer.svg" alt="options" fill />
                          </button>
                        }
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            } @else {
              @defer {
                <tbody>
                  <td colspan="100%">
                    <app-application-not-found />
                  </td>
                </tbody>
              }
            }
          }
        </table>
      </div>

      @defer {
        @if (application()?.pagination) {
          <div class="mt-4">
            <app-pagination />
          </div>
        }
      }
    </section>
  </div>
</div>

<app-modal #deleteApplicationModal>
  <div class="fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50 z-50">
    <div class="bg-white w-full max-w-xl rounded-lg overflow-auto">
      <header class="p-4 flex justify-between items-center border-b border-gray-300">
        <h2 class="font-bold text-xl truncate">Delete Application</h2>
        <button (click)="deleteApplicationModal.close()" class="shrink-0">
          <img
            ngSrc="/assets/icons/close-icon.svg"
            width="14"
            height="18"
            alt="close"
            style="filter: invert(64%) sepia(1%) saturate(370%) hue-rotate(314deg) brightness(94%) contrast(91%)"
          />
        </button>
      </header>
      @defer (when permissions.hasPermission(permission.DELETE_APPLICATION)) {
        @if (wiewing(); as id) {
          <app-delete-application
            [id]="id"
            (applicationDeleted)="deleteApplicationModal.close(); wiewing.set(null)"
            (applicationDeleted)="$event && onSearch()"
          />
        }
      }
    </div>
  </div>
</app-modal>

<app-modal #transferAppModal>
  @defer {
    <div class="flex items-center justify-center">
      <div class="bg-white w-full max-w-lg rounded-lg overflow-auto">
        <header class="p-4 flex justify-between items-center border-b border-gray-300">
          <h2 class="font-bold text-xl truncate">Assign App to user</h2>
          <button (click)="transferAppModal.close()" class="shrink-0">
            <img ngSrc="/assets/icons/close-icon.svg" width="14" height="18" alt="Close" class="opacity-50" />
          </button>
        </header>

        @if (wiewing(); as app) {
          <app-transfer-application [applicationId]="app" (appTransfered)="onSearch(); transferAppModal.close()" />
        }
      </div>
    </div>
  }
</app-modal>
