@if (loading()) {
  <div class="h-full text-center flex justify-center items-center">
    <div class="loader"></div>
  </div>
} @else {
  @if (viewing(); as draft) {
    <div class="flex flex-col lg:flex-row gap-4 p-4">
      <aside class="w-full lg:w-1/3 flex flex-col gap-2">
        <div class="bg-white rounded-lg shadow p-4 py-6">
          <a [routerLink]="['/', 'companies', draft.company.id]" target="_blank">
            <header class="flex items-center gap-4 mb-4 cursor-pointer">
              <div class="bg-blue-950 text-white rounded-lg flex items-center justify-center size-10 shrink-0">
                {{ draft.company.name | initials }}
              </div>
              <div class="flex-grow truncate">
                <div class="flex items-center justify-between truncate">
                  <h2 class="text-lg font-bold truncate">
                    {{ draft.company.name }}
                  </h2>
                  <div class="relative size-5 shrink-0">
                    <img
                      [ngSrc]="
                        'https://raw.githubusercontent.com/hampusborgos/country-flags/main/svg/' +
                        draft.company.address.country_iso_code_2.toLowerCase() +
                        '.svg'
                      "
                      [alt]="draft.company.address.country_iso_code_2"
                      fill
                    />
                  </div>
                </div>
                <p class="text-sm text-gray-500">{{ draft.company.dba }}</p>
              </div>
            </header>
          </a>

          <div class="bg-emerald-500 text-white p-2 rounded-md text-center mb-4">
            Looking for: {{ draft.loan_amount | currency }}
          </div>
          <hr class="my-3" />
          <h4 class="text-stone-500">{{ config.productType()[draft.product] }}</h4>
          <hr class="my-3" />

          <div class="mb-2">
            <div class="text-gray-700 *:mb-4 last:*:mb-0">
              <div class="flex items-center gap-2">
                <div class="bg-blue-300 rounded-full size-6 flex items-center justify-center shrink-0">
                  <img src="/assets/icons/email.svg" alt="Email Icon" class="size-3" />
                </div>
                <div class="flex flex-col truncate">
                  @for (email of draft.company.emails; track $index) {
                    <span class="truncate">{{ email }}</span>
                  }
                </div>
              </div>
              <div class="flex items-center gap-2">
                <div class="bg-blue-300 rounded-full size-6 flex items-center justify-center shrink-0">
                  <img src="/assets/icons/phone.svg" alt="Phone Icon" class="size-3" />
                </div>
                <div class="flex flex-wrap">
                  @for (phone of draft.company.phone_numbers; track $index) {
                    <span>{{ phone | formatPhone }}</span>
                  }
                </div>
              </div>

              <div class="flex items-start gap-2">
                <div class="bg-blue-300 rounded-full size-6 shrink-0 flex items-center justify-center">
                  <img src="/assets/icons/location.svg" alt="Location Icon" class="size-3" />
                </div>
                <div>{{ draft.company.address | address | async }}</div>
              </div>
            </div>
          </div>

          <hr class="my-3" />
          <h4 class="text-stone-500 mb-4">Members</h4>

          <div class="grid md:grid-cols-2 grid-cols-1 gap-4">
            @for (member of draft.company.members; track $index) {
              <a [routerLink]="['/', 'contacts', member.contact.id]" target="_blank">
                <div class="flex items-center gap-2">
                  <div class="bg-red-600 rounded-full size-8 flex items-center justify-center shrink-0">
                    <img src="/assets/icons/menu_contacts.svg" alt="Contact" class="size-4" />
                  </div>
                  <div>
                    <p class="text-gray-700">{{ member.contact.first_name }} {{ member.contact.last_name }}</p>
                    <p class="text-sm text-gray-500">{{ member.title }} ({{ member.percentage }}%)</p>
                  </div>
                </div>
              </a>
            }
          </div>
          @if (draft.signature_url) {
            <hr class="my-3" />
            <h4 class="text-stone-500 mb-4">Signature</h4>
            <img [src]="draft.signature_url" alt="Signature" class="w-full h-auto" />
          }
        </div>

        <!-- Company documents -->
        @if (draft.company.documents.length) {
          <div class="bg-white rounded-lg shadow p-4 py-6">
            <div class="group open" #companyDocuments>
              <div class="flex justify-between items-center">
                <button (click)="companyDocuments.classList.toggle('open')" class="flex gap-2 items-center">
                  <h3 class="text-black">Company documents</h3>
                  <div class="relative size-3 rotate-180 group-[.open]:rotate-0 transition-all">
                    <img ngSrc="/assets/icons/arrow-down.svg" fill alt="" />
                  </div>
                </button>
              </div>
              <hr class="my-2" />
              <div class="mb-2 grid grid-rows-[0fr] transition-all group-[.open]:grid-rows-[1fr]">
                <div class="overflow-hidden">
                  <div class="mb-2 *:mb-3 *:block">
                    @for (item of draft.company.documents; track $index) {
                      <app-application-document
                        [name]="item.name!"
                        [type]="item.type!"
                        [docType]="item.docType"
                        [source]="item.source"
                      />
                    }
                  </div>
                </div>
              </div>
            </div>
          </div>
        }
      </aside>
      <main class="flex flex-col gap-4 w-full lg:w-3/4">
        <div class="flex flex-col lg:flex-row gap-4 w-full">
          <div class="w-full">
            <section class="bg-white rounded-lg shadow p-4 w-full">
              <div class="tab-content">
                <app-update-documents [draft]="draft" />
              </div>
            </section>
            <button
              type="submit"
              class="w-full px-4 py-2 text-white bg-red-600 rounded-md mt-4"
              (click)="publishDraftModal.open()"
            >
              Publish
            </button>
          </div>
        </div>
      </main>
    </div>

    <app-modal #publishDraftModal>
      <div class="fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50 z-50">
        <div class="bg-white w-full max-w-xl rounded-lg overflow-auto">
          <header class="p-4 flex justify-between items-center border-b border-gray-300">
            <h2 class="font-bold text-xl truncate">Publish Draft</h2>
            <button (click)="publishDraftModal.close()" class="shrink-0">
              <img
                ngSrc="/assets/icons/close-icon.svg"
                width="14"
                height="18"
                alt="close"
                style="filter: invert(64%) sepia(1%) saturate(370%) hue-rotate(314deg) brightness(94%) contrast(91%)"
              />
            </button>
          </header>
          @defer (when permissions.hasPermission(permission.PUBLISH_DRAFT_APPLICATION)) {
            <app-publish-draft [draftId]="draft.id" (draftPublished)="publishDraftModal.close()" />
          }
        </div>
      </div>
    </app-modal>
  }
}
