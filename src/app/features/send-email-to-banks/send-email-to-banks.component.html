<div class="p-7">
  <div class="rounded-2xl shadow bg-white p-6">
    <h1 class="text-2xl font-bold mb-6">Send Email to Banks</h1>

    <form [formGroup]="form" (ngSubmit)="submit()">
      <!-- Subject -->
      <div class="mb-6">
        <app-custom-input formControlName="subject" label="Subject *" placeholder="" groupClass="mb-2" />
        <div class="text-right">
          <span class="text-xs text-gray-500">{{ form.value.subject?.length || 0 }}/35</span>
        </div>
      </div>

      <!-- Banks Section -->
      <div class="mb-6">
        <div class="flex justify-between items-center mb-4">
          <span class="block text-lg font-medium text-gray-700"> Banks <span class="text-red-500">*</span> </span>
          <button
            type="button"
            (click)="bankSelectionModal.open()"
            class="flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <span class="text-xl">+</span>
          </button>
        </div>

        <div class="flex flex-wrap gap-2 mb-4">
          @let banks = form.controls.banks.value ?? [];
          @for (bank of banks; track bank.id) {
            <div class="flex items-center gap-2 bg-gray-100 text-gray-800 px-3 py-2 rounded-md">
              <div class="bg-primary rounded text-white px-2">
                {{ bank.name | initials }}
              </div>
              <span>{{ bank.name }}</span>
              <button
                type="button"
                (click)="removeBank(bank.id)"
                class="ml-2 size-4 flex items-center justify-center hover:opacity-70"
              >
                <img src="/assets/icons/trash-icon.svg" alt="Remove" class="size-4" />
              </button>
            </div>
          }
        </div>
        <app-form-error-message [control]="form.controls.banks" />
      </div>

      <!-- Message -->
      <div class="mb-6">
        <div class="mb-2">
          <div class="relative">
            <textarea
              id="message"
              formControlName="message"
              maxlength="2000"
              rows="6"
              placeholder=""
              class="peer w-full border-b-2 border-gray-300 focus:border-secondary outline-none text-gray-600 py-2 resize-vertical"
            ></textarea>
            <label
              for="message"
              class="absolute left-0 -top-3.5 text-gray-400 transition-all peer-placeholder-shown:top-2 peer-placeholder-shown:text-base text-sm peer-placeholder-shown:text-gray-400 peer-focus:-top-3.5 peer-focus:text-sm peer-focus:text-secondary"
            >
              Message *
            </label>
          </div>
          <app-form-error-message [control]="form.controls.message" />
        </div>
        <div class="text-right">
          <span class="text-xs text-gray-500">{{ form.value.message?.length || 0 }}/2000</span>
        </div>
      </div>

      <!-- Attachments Section -->
      <div class="mb-6">
        <div class="flex justify-between items-center mb-4">
          <span class="block text-lg font-medium text-gray-700"> Attachments <span class="text-red-500">*</span> </span>
          <button
            type="button"
            (click)="attachmentSelectionModal.open()"
            class="flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <span class="text-xl">+</span>
          </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 mb-4">
          @let attachments = form.controls.attachments.value ?? [];
          @for (attachment of attachments; track attachment.document_id) {
            <app-remote-file-handler
              [name]="attachment.document_name"
              [type]="attachment.file_type"
              [source]="attachment.source"
              (deleted)="removeAttachment(attachment.document_id)"
            />
          }
        </div>
        <app-form-error-message [control]="form.controls.attachments" />
      </div>

      <div class="flex justify-end items-center">
        <div>
          @if (!loading()) {
            <button
              type="submit"
              [disabled]="form.invalid"
              class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark disabled:opacity-50 disabled:cursor-not-allowed font-medium"
            >
              Send Email to {{ form.controls.banks.value?.length }} Bank(s)
            </button>
          } @else {
            <div class="flex items-center gap-3 px-6 py-3">
              <div class="loader"></div>
              <span>Sending email...</span>
            </div>
          }
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Bank Selection Modal -->
<app-modal #bankSelectionModal>
  <div class="flex items-center justify-center">
    <div class="bg-white w-full max-w-2xl rounded-lg overflow-auto max-h-full">
      <header class="p-4 flex justify-between items-center border-b border-gray-300">
        <h2 class="font-bold text-xl truncate">Select Banks</h2>
        <button (click)="bankSelectionModal.close()" class="shrink-0">
          <img ngSrc="/assets/icons/close-icon.svg" width="14" height="18" alt="Close" class="opacity-50" />
        </button>
      </header>
      <app-bank-selector (banksSelected)="updateBanks($event); bankSelectionModal.close()" />
    </div>
  </div>
</app-modal>

<!-- Attachment Selection Modal -->
<app-modal #attachmentSelectionModal>
  <div class="flex items-center justify-center">
    <div class="bg-white w-full max-w-3xl rounded-lg overflow-auto max-h-full">
      <header class="p-4 flex justify-between items-center border-b border-gray-300">
        <h2 class="font-bold text-xl truncate">Select Attachments</h2>
        <button (click)="attachmentSelectionModal.close()" class="shrink-0">
          <img ngSrc="/assets/icons/close-icon.svg" width="14" height="18" alt="Close" class="opacity-50" />
        </button>
      </header>
      <app-attachment-selector (documentsSelected)="updateAttachments($event); attachmentSelectionModal.close()" />
    </div>
  </div>
</app-modal>
