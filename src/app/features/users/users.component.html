<div class="p-7">
  <div class="rounded-2xl shadow bg-white p-6">
    <nav class="flex gap-4 justify-between items-center flex-wrap md:flex-row flex-col">
      <!-- Search -->
      <div class="bg-stone-100 w-full md:max-w-96 flex h-11 items-center rounded-2xl ps-4 gap-4">
        <label
          for="searchCompany"
          class="relative size-4 shrink-0 cursor-pointer"
          (click)="this.searchService.updateQuery(search)"
          ><img ngSrc="/assets/icons/search.svg" alt="Search" fill
        /></label>
        <input
          type="text"
          [(ngModel)]="search"
          id="searchCompany"
          (keyup.enter)="this.searchService.updateQuery(search)"
          placeholder="search"
          class="bg-transparent grow h-full px-2"
        />
      </div>

      <div class="max-md:w-full">
        <button class="flex items-center gap-2 bg-secondary text-white px-4 py-2 rounded-lg" (click)="newUser.open()">
          <div class="relative size-5 shrink-0"><img ngSrc="/assets/icons/add.svg" alt="Create" fill /></div>
          Create
        </button>
      </div>
    </nav>

    <hr class="my-4" />
    <section>
      <div class="relative overflow-x-auto">
        <table class="w-full text-left">
          <thead>
            <tr class="*:font-normal *:text-neutral-400 *:px-6 *:py-3">
              <th scope="col">Name</th>
              <th scope="col">Email</th>
              <th scope="col">Status</th>
              <th scope="col">Creation Date</th>
              <th scope="col" class="text-end">Actions</th>
            </tr>
          </thead>
          @if (loading()) {
            <tbody>
              <td colspan="100%">
                <div class="text-center py-9">
                  <div class="loader"></div>
                </div>
              </td>
            </tbody>
          } @else {
            @if (users() && users()!.data!.length > 0) {
              <tbody>
                @for (user of users()?.data; track user.id) {
                  <tr
                    class="bg-white border-b border-dashed border-neutral-200 *:px-6 *:py-4 *:whitespace-nowrap [&>th]:ps-0"
                  >
                    <th scope="row" class="font-normal">
                      <a>
                        <div class="flex gap-4 items-center">
                          <div
                            class="size-10 bg-primary rounded-lg text-white flex items-center justify-center uppercase"
                          >
                            {{ user.first_name + ' ' + user.last_name | initials }}
                          </div>
                          <div>
                            <p class="font-bold">{{ user.first_name + ' ' + user.last_name }}</p>
                          </div>
                        </div>
                      </a>
                    </th>
                    <td>
                      {{ user.email }}
                    </td>
                    <td>
                      <p
                        class="text-center rounded-lg first-letter:capitalize inline-block px-3 py-1 min-w-24"
                        [ngClass]="user.status === 'ACTIVE' ? 'bg-emerald-500 text-white' : 'bg-stone-300'"
                      >
                        {{ user.status }}
                      </p>
                    </td>
                    <td>{{ user.created_at | customDate }}</td>
                    <td class="flex gap-2 justify-end">
                      <button class="size-4 relative" (click)="current.set(user); editUser.open()">
                        <img ngSrc="/assets/icons/edit.svg" alt="edit" fill />
                      </button>

                      <button class="size-4 relative" (click)="current.set(user); toggleUser.open()">
                        <img
                          [ngSrc]="
                            user.status === 'ACTIVE' ? '/assets/icons/trash-icon.svg' : '/assets/icons/check-icon.svg'
                          "
                          alt="disable/enable"
                          fill
                        />
                      </button>
                    </td>
                  </tr>
                }
              </tbody>
            } @else {
              @defer {
                <tbody>
                  <td colspan="100%">
                    <app-user-not-found />
                  </td>
                </tbody>
              }
            }
          }
        </table>
      </div>

      @defer {
        @if (users()?.pagination) {
          <div class="mt-4">
            <app-pagination />
          </div>
        }
      }
    </section>
  </div>
</div>

<app-modal #newUser (closed)="current.set(null)">
  @defer {
    <div class="h-full flex items-center">
      <div class="bg-white w-full rounded-lg overflow-auto max-h-full">
        <header class="p-4 flex justify-between items-center border border-b border-gray-300">
          <h2 class="font-bold text-xl truncate">New User</h2>
          <button (click)="newUser.close()" class="shrink-0">
            <img ngSrc="/assets/icons/close-icon.svg" width="14" height="18" alt="close" class="opacity-50" />
          </button>
        </header>
        <section class="p-4">
          <app-create-user
            (user)="newUser.close()"
            (userCreated)="$event && searchUser()"
            (userCreated)="newUser.close()"
          />
        </section>
      </div>
    </div>
  }
</app-modal>

<app-modal #editUser (closed)="current.set(null)">
  @defer {
    <div class="h-full flex items-center">
      <div class="bg-white w-full rounded-lg overflow-auto max-h-full">
        <header class="p-4 flex justify-between items-center border border-b border-gray-300">
          <h2 class="font-bold text-xl truncate">Edit User</h2>
          <button (click)="editUser.close()" class="shrink-0">
            <img ngSrc="/assets/icons/close-icon.svg" width="14" height="18" alt="close" class="opacity-50" />
          </button>
        </header>
        <section class="p-4">
          @if (current()) {
            <app-update-user
              [user]="current()!"
              (userUpdated)="$event && searchUser()"
              (userUpdated)="editUser.close()"
            />
          }
        </section>
      </div>
    </div>
  }
</app-modal>

<app-modal #toggleUser (closed)="current.set(null)">
  @defer {
    <div class="h-full flex items-center">
      <div class="bg-white w-full max-w-md mx-auto rounded-lg overflow-auto max-h-full">
        <header class="p-4 flex justify-between items-center border border-b border-gray-300">
          <h2 class="font-bold text-xl truncate">Disable/Enable User</h2>
          <button (click)="toggleUser.close()" class="shrink-0">
            <img ngSrc="/assets/icons/close-icon.svg" width="14" height="18" alt="close" class="opacity-50" />
          </button>
        </header>
        <section class="p-4">
          @if (current()) {
            <app-toggle-user
              [user]="current()!"
              (userUpdated)="$event && searchUser()"
              (userUpdated)="toggleUser.close()"
            />
          }
        </section>
      </div>
    </div>
  }
</app-modal>
